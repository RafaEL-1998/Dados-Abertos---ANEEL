import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
import datetime

# === CONFIGURA√á√ïES === #
pd.set_option('display.max_columns', None)
plt.style.use('seaborn-v0_8')

# Ajuste o nome do seu arquivo
arquivo = "interrupcoes_filtrado_ELEKTRO.csv"

# === 1. Carregar os dados === #
print("üîç Carregando base de dados...")
df = pd.read_csv(arquivo, sep=',', encoding='latin1', low_memory=False)
base_original = len(df)

# === 2. Filtrar colunas de interesse === #
colunas = [
    "NumAno",
    "SigAgente",
    "DscConjuntoUnidadeConsumidora",
    "DscAlimentadorSubestacao",
    "DatInicioInterrupcao",
    "DatFimInterrupcao",
    "DscSubestacaoDistribuicao",
    "NumNivelTensao",
    "DscFatoGeradorInterrupcao",
    "NumUnidadeConsumidora"
]

# === 3. Tratamento vari√°veis quant. e quali. === #
col_valor = 'NumUnidadeConsumidora'
cols_sem_valor = df.columns[:-1]

df_tratado = (
    df.sort_values(by=col_valor, ascending=False)
      .drop_duplicates(subset=cols_sem_valor, keep='first')
      .reset_index(drop=True)
)

df_tratado.to_csv('dados_tratados.csv', sep=',', index=False, encoding='latin1')
df = df_tratado[colunas]
qtd_repetidos = base_original - len(df_tratado)

# --- 3.2 Quebrar a string da coluna DscFatoGeradorInterrupcao --- #
# Exemplo de c√©lula: Interna/Nao Programada/Meio Ambiente/Descarga Atmosferica

df[['Origem', 'Tipo', 'Classe', 'Causa']] = (
    df['DscFatoGeradorInterrupcao']
    .astype(str)
    .str.split('/', n=3, expand=True)
    .fillna('')
)

# Limpeza de espa√ßos e normaliza√ß√£o
df[['Origem', 'Tipo', 'Classe', 'Causa']] = (
    df[['Origem', 'Tipo', 'Classe', 'Causa']]
    .apply(lambda x: x.str.strip().str.title())
)

# Substituir valores inv√°lidos
df['Causa'] = df['Causa'].replace({'': np.nan, '-': np.nan})
df['Classe'] = df['Classe'].replace({'': np.nan, '-': np.nan})
df.loc[df["Classe"] == "N√£o Classificada", "Causa"] = "N√£o Classificada"

print(f"‚úÖ Tratamento de dados conclu√≠do: {list(df.columns)}")
print(f"üìä Total de registros: {len(df):,}")
print(f"üóëÔ∏è Retirado(s) {qtd_repetidos} linhas repetidas")

# === 4. Tratar valores ausentes e tipos === #
df = df.dropna(subset=['Causa', 'NumUnidadeConsumidora'])
df['NumUnidadeConsumidora'] = pd.to_numeric(df['NumUnidadeConsumidora'], errors='coerce').fillna(0)

print(f"\nResumo r√°pido:")

# === 5. Soma total de consumidores afetados === #
total_consumidores = df['NumUnidadeConsumidora'].sum()
print(f"\nüë• Total de consumidores afetados no ano de {df['NumAno'].iloc[0]}: {int(total_consumidores):,}")

# === 6. Causas x Quantidade === #
df_nao_programadas = df[df['Tipo'].str.upper().str.contains('NAO PROGRAMADA')]
causas_nao_programadas = df_nao_programadas['Causa'].value_counts()
print("\n‚ö° Causas de interrup√ß√µes N√ÉO PROGRAMADAS:")
print(causas_nao_programadas.head(10))

df_programadas = df[df['Tipo'].str.upper().str.contains('PROGRAMADA')]
causas_programadas = df_programadas['Causa'].value_counts()
print("\nüõ†Ô∏è Principais causas de interrup√ß√£o PROGRAMADAS:")
print(causas_programadas.head(10))

# === 7. Causas que mais afetaram consumidores === #
consumidores_por_causa = df.groupby('Causa')['NumUnidadeConsumidora'].sum().sort_values(ascending=False)
print(f"\nüî• Causas que mais afetaram consumidores em {df['NumAno'].iloc[0]}:")
print(consumidores_por_causa.head(10))

# === 8. Dura√ß√£o das interrup√ß√µes === #
df['DatInicioInterrupcao'] = pd.to_datetime(df['DatInicioInterrupcao'])
df['DatFimInterrupcao'] = pd.to_datetime(df['DatFimInterrupcao'])
df['Duracao_timedelta'] = df['DatFimInterrupcao'] - df['DatInicioInterrupcao']
df['Duracao_horas'] = df['Duracao_timedelta'].dt.total_seconds() / 3600

bins = [0, 6, 12, 24, 48, 72, float('inf')]
labels = ['At√© 6h', '6h a 12h', '12h a 24h', '24h a 48h', '48h a 72h', 'Acima de 72h']
df['Duracao_categoria'] = pd.cut(df['Duracao_horas'], bins=bins, labels=labels, right=False).astype(str)

duracao_interrupcoes = df['Duracao_categoria'].value_counts().reindex(labels)

# === 9. Gr√°ficos === #
plt.figure(figsize=(10,6))
duracao_interrupcoes.plot(kind='bar', color='steelblue')
plt.title(f'Distribui√ß√£o das interrup√ß√µes por dura√ß√£o em {df["NumAno"].iloc[0]}')
plt.xlabel('Dura√ß√£o da Interrup√ß√£o')
plt.ylabel('Quantidade de Ocorr√™ncias')
plt.xticks(rotation=45, ha='right')
plt.tight_layout()
plt.show()

plt.figure(figsize=(10,5))
causas_nao_programadas.head(10).plot(kind='bar', color='indianred')
plt.title(f'Principais causas de interrup√ß√µes N√£o Programadas em {df["NumAno"].iloc[0]}')
plt.ylabel('Ocorr√™ncias')
plt.xlabel('Causas')
plt.xticks(rotation=45, ha='right')
plt.tight_layout()
plt.show()

plt.figure(figsize=(10,5))
causas_programadas.head(5).plot(kind='bar', color='steelblue')
plt.title(f'Interrup√ß√µes Programadas em {df["NumAno"].iloc[0]}')
plt.ylabel('Ocorr√™ncias')
plt.xlabel('Causas')
plt.xticks(rotation=0, ha='center')
plt.tight_layout()
plt.show()

plt.figure(figsize=(10,5))
consumidores_por_causa.head(10).plot(kind='bar', color='darkgreen')
plt.title(f'Causas que mais afetaram consumidores em {df["NumAno"].iloc[0]}')
plt.ylabel('Total de consumidores afetados')
plt.xlabel('Causas')
plt.xticks(rotation=45, ha='right')
plt.tight_layout()
plt.show()

plt.figure(figsize=(8,8))
causas_nao_programadas.head(6).plot(kind='pie', autopct='%1.1f%%', startangle=90)
plt.title(f'Percentual das principais causas nas interrup√ß√µes N√£o Programadas ({df["NumAno"].iloc[0]})')
plt.ylabel('')
plt.tight_layout()
plt.show()

# === 10. Exportar resultados === #
causas_nao_prog_df = causas_nao_programadas.reset_index().rename(columns={'index': 'Causa', 'Causa': 'Qtd'})
causas_prog_df = causas_programadas.reset_index().rename(columns={'index': 'Causa', 'Causa': 'Qtd'})
consumidores_por_causa_df = consumidores_por_causa.reset_index().rename(columns={'index': 'Causa', 'NumUnidadeConsumidora': 'TotalConsumidores'})
duracao_interrupcoes_df = duracao_interrupcoes.reset_index().rename(columns={'index': 'Duracao', 'Duracao_categoria': 'Qtd'})

with pd.ExcelWriter('analise_interrupcoes_ELEKTRO.xlsx', engine='xlsxwriter') as writer:
    df.to_excel(writer, sheet_name='Base Filtrada', index=False)
    causas_nao_prog_df.to_excel(writer, sheet_name='Causas Nao Prog', index=False)
    causas_prog_df.to_excel(writer, sheet_name='Causas Programadas', index=False)
    consumidores_por_causa_df.to_excel(writer, sheet_name='Consumidores por Causa', index=False)
    duracao_interrupcoes_df.to_excel(writer, sheet_name='Duracao Ocorrencias', index=False)

print("\nüíæ Resultados salvos em: analise_interrupcoes_ELEKTRO.xlsx")
print("‚úÖ An√°lise conclu√≠da com sucesso!")

